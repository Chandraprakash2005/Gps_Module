<!DOCTYPE html>
<html>
<head>
  <title>Campus Navigation (Click to Select)</title>

  <link rel="stylesheet"
        href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100%; }

    .control-box {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
  </style>
</head>

<body>

<div class="control-box">
  <b>Instructions</b><br>
  üñ•Ô∏è PC is source<br>
  üñ±Ô∏è Click on map to choose destination<br>
  <button onclick="calculateRoute()">Find Path</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let currentPosition = null;
let sourceMarker = null;
let destMarker = null;
let routeLayer = null;

const map = L.map("map").setView([12.7517, 80.1993], 16);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

// ========== LIVE GPS ==========
navigator.geolocation.watchPosition(
  (pos) => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    currentPosition = [lng, lat];

    if (sourceMarker) map.removeLayer(sourceMarker);
    sourceMarker = L.marker([lat, lng])
      .addTo(map)
      .bindPopup("You are here")
      .openPopup();
  },
  () => alert("GPS error"),
  { enableHighAccuracy:true }
);

// ========== SEND GPS TO PC ==========
setInterval(() => {
  if (currentPosition) {
    fetch("/gps", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ pos: currentPosition })
    });
  }
}, 1000);

// ========== MAP CLICK ==========
map.on("click", (e) => {
  if (!currentPosition) {
    alert("Waiting for GPS...");
    return;
  }

  const dest = [e.latlng.lng, e.latlng.lat];

  if (destMarker) map.removeLayer(destMarker);
  destMarker = L.marker([dest[1], dest[0]])
    .addTo(map)
    .bindPopup("Destination")
    .openPopup();

  calculateRoute(currentPosition, dest);
});

// ========== REQUEST ROUTE FROM PC ==========
async function calculateRoute(start, end) {
  const res = await fetch("/route", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ coordinates:[start,end] })
  });

  const data = await res.json();

  console.log("Commands:", data.commands);
  console.log("Distance:", data.distance);
  console.log("Duration:", data.duration);

  sendToPi(data.commands);
}

// ========== SEND TO PI ==========
async function sendToPi(commands) {
  try {
    const res = await fetch("http://10.177.21.229:5000/route", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ commands })
    });

    const data = await res.json();
    console.log("Pi:", data);
  } catch(e) {
    console.error("Pi error", e);
  }
}

let robotMarker = null;
let targetMarker = null;

setInterval(async () => {
    try {
        const res = await fetch("/gps/live");
        const data = await res.json();

        if (!data.pos) return;

        const lat = data.pos[1];
        const lng = data.pos[0];

        if (!robotMarker) {
            robotMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: "https://cdn-icons-png.flaticon.com/512/854/854878.png",
                    iconSize: [40,40]
                })
            }).addTo(map).bindPopup("ü§ñ Robot");
        } else {
            robotMarker.setLatLng([lat,lng]);
        }

        // Show target waypoint
        if (data.target) {
            const tlat = data.target[1];
            const tlng = data.target[0];

            if (!targetMarker) {
                targetMarker = L.circleMarker([tlat,tlng], {
                    radius: 10,
                    color: "red"
                }).addTo(map);
            } else {
                targetMarker.setLatLng([tlat,tlng]);
            }
        }

    } catch(e){}
}, 1000);

let driftLine = null;

function drawDrift(robot, target){
    if (driftLine) map.removeLayer(driftLine);

    driftLine = L.polyline([
        [robot[1],robot[0]],
        [target[1],target[0]]
    ], {color:"red", dashArray:"5,5"}).addTo(map);
}

</script>

</body>
</html>
